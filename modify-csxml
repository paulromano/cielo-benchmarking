#!/bin/bash

# This script requires the following files to be present:
#   cross_sections_nndc.xml
#   xsdir
#
# With these two files, the script will create a new file called
# cross_sections_new.xml where the O-16 nuclide has been replaced with
# the one generated by NJOY

set -e

cross_sections=$(pwd)/cross_sections_nndc.xml

if [[ $# -ge 1 ]]; then
    cd $1
fi

# Add 'atomic weight ratios' to xsdir file
sed -e '1i atomic weight ratios\ndirectory' -e "s|filename|$(pwd)/ace|" -e 's/route/0/' xsdir > xsdir_mod

# Convert to OpenMC XML format and only keep relevant line
$(dirname $(which openmc))/../../utils/convert_xsdir.py xsdir_mod o16.xml
sed -i -n -e '/O-16/ p' o16.xml

# Get line number for O-16 entry
linenum=$(grep -n O-16 $cross_sections | awk '{print $1}' | sed 's/://' | head -1)

# Replace line in cross_sections.xml with appropriate one
sed -e "$linenum d" < $cross_sections | \
    sed -e "$(expr $linenum \- 1) r o16.xml" > cross_sections_new.xml

# Clean up files
rm xsdir_mod o16.xml
